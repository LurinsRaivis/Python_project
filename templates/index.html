<!DOCTYPE html>
<html>
<head>
    <title>Geography Game</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
        body {
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        input[type="text"] {
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Geography Game</h1>
        <div id="mapSelection">
            <button id="emptyMapButton">Empty Map</button>
            <button id="outlinedMapButton">Map with Country Outlines</button>
        </div>
        <p id="startCountry"></p>
        <p id="targetCountry"></p>
        <div id="map"></div>
        <input type="text" id="countryInput" placeholder="Enter a country..." />
        <button id="guessButton">Guess</button>
    </div>

    <!-- Include Leaflet.js -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- Custom JavaScript for the map and game logic -->
    <script>
        
        var map = L.map('map').setView([51.505, -0.09], 2);
        var geojsonLayer;
        var currentCountry = null;

        function clearMapHighlights() {
            map.eachLayer(function(layer) {
                if (layer instanceof L.GeoJSON) {
                    map.removeLayer(layer);
                }
            });
        }

        function highlightStyle(color) {
            return {
                weight: 1,
                color: 'black',
                fillOpacity: 0.7,
                fillColor: color
            };
        }

        function selectCountry(countryName, color) {
            fetch('/static/countries.geojson')
                .then(response => response.json())
                .then(data => {
                    var found = false;
                    data.features.forEach(function(feature) {
                        if (feature.properties.ADMIN === countryName) {
                            L.geoJSON(feature, { style: highlightStyle(color) }).addTo(map);
                            found = true;
                        }
                    });
                    if (!found) {
                        alert('Country not found');
                    }
                });
        }

        function getRandomCountriesAndHighlight() {
            clearMapHighlights();
            fetch('/random-countries')
                .then(response => response.json())
                .then(data => {
                    currentCountry = data.start_country;
                    selectCountry(data.start_country, 'red');
                    selectCountry(data.target_country, 'green');
                    document.getElementById('startCountry').textContent = "Start: " + data.start_country;
                    document.getElementById('targetCountry').textContent = "End: " + data.target_country;
                })
                .catch(error => console.error('Error:', error));
        }

        document.getElementById('guessButton').addEventListener('click', function() {
            var guessedCountry = document.getElementById('countryInput').value;
            fetch('/check-neighbor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ current_country: currentCountry, guess: guessedCountry })
            })
            .then(response => response.json())
            .then(data => {
                if(data.is_neighbor) {
                    selectCountry(guessedCountry, 'yellow');
                    currentCountry = guessedCountry;
                } else {
                    alert('That country is not a neighboring country.');
                }
            })
            .catch(error => console.error('Error:', error));
        });

        document.getElementById('emptyMapButton').addEventListener('click', function() {
            document.getElementById('map').style.display = 'block';
            document.getElementById('mapSelection').style.display = 'none';
            initializeEmptyMap();
        });

        document.getElementById('outlinedMapButton').addEventListener('click', function() {
            document.getElementById('map').style.display = 'block';
            document.getElementById('mapSelection').style.display = 'none';
            initializeMapWithOutlines();
        });

        function initializeMapWithOutlines() {
            fetch('/static/countries.geojson')
                .then(response => response.json())
                .then(data => {
                    geojsonLayer = L.geoJSON(data, {
                        style: function(feature) {
                            return {color: "#000000", weight: 1, fillOpacity: 0};
                        }
                    }).addTo(map);
                    getRandomCountriesAndHighlight();
                });
        }

        function initializeEmptyMap() {
            if (geojsonLayer) {
                geojsonLayer.remove();
            }
            getRandomCountriesAndHighlight();
        }

        function autocomplete(inp) {
            inp.addEventListener("input", function(e) {
                var a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false; }

                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);

                fetch(`https://restcountries.com/v3.1/name/${val}`)
                    .then(response => response.json())
                    .then(countries => {
                        countries.forEach(country => {
                            b = document.createElement("DIV");
                            b.innerHTML = "<strong>" + country.name.common.substr(0, val.length) + "</strong>";
                            b.innerHTML += country.name.common.substr(val.length);
                            b.innerHTML += "<input type='hidden' value='" + country.name.common + "'>";
                            b.addEventListener("click", function(e) {
                                inp.value = this.getElementsByTagName("input")[0].value;
                                closeAllLists();
                            });
                            a.appendChild(b);
                        });
                    })
                    .catch(error => console.error('Error:', error));
            });

            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }
        function testGeoJSON() {
            fetch('/static/countries.geojson')
                .then(response => response.json())
                .then(data => {
                    L.geoJSON(data).addTo(map);
                });
        }

        // Call this function directly to test
        testGeoJSON();

        autocomplete(document.getElementById("countryInput"));

        window.onload = function() {
            document.getElementById('map').style.display = 'none';
        };

    </script>
</body>
</html>
